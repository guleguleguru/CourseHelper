# æ ¸å¿ƒæ–‡ä»¶ä½ç½®ä¸è¿è¡Œæµç¨‹

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
release_bundle/
â”‚
â”œâ”€â”€ ğŸš€ å…¥å£æ–‡ä»¶ï¼ˆç”¨æˆ·å¯åŠ¨ï¼‰
â”‚   â”œâ”€â”€ app.py                    # Web ç•Œé¢å…¥å£
â”‚   â”œâ”€â”€ main.py                   # CLI å…¥å£
â”‚   â””â”€â”€ build_index.py            # ç´¢å¼•æ„å»ºå…¥å£
â”‚
â”œâ”€â”€ ğŸ§  Agent æ ¸å¿ƒï¼ˆå¤§è„‘ï¼‰
â”‚   â””â”€â”€ src/agent/
â”‚       â”œâ”€â”€ research_agent.py     # â­ Agent ä¸»ç±»ï¼ˆæ ¸å¿ƒï¼‰
â”‚       â””â”€â”€ prompts.py            # System Prompt å®šä¹‰
â”‚
â”œâ”€â”€ ğŸ”§ å·¥å…·å®ç°ï¼ˆAgent çš„"æ‰‹"ï¼‰
â”‚   â””â”€â”€ src/tools/
â”‚       â”œâ”€â”€ retriever_tool.py     # RAG æ£€ç´¢å·¥å…·
â”‚       â””â”€â”€ pandas_runner_tool.py # æ•°æ®åˆ†æå·¥å…·
â”‚
â”œâ”€â”€ ğŸ“š æ•°æ®æ‘„å…¥ï¼ˆçŸ¥è¯†åº“å¤„ç†ï¼‰
â”‚   â””â”€â”€ src/ingest/
â”‚       â”œâ”€â”€ document_loader.py    # æ–‡æ¡£åŠ è½½å™¨
â”‚       â””â”€â”€ indexer.py            # ç´¢å¼•æ„å»ºå™¨
â”‚
â””â”€â”€ âš™ï¸ å·¥å…·å‡½æ•°
    â””â”€â”€ src/utils.py              # é…ç½®åŠ è½½ç­‰å·¥å…·å‡½æ•°
```

---

## ğŸ¯ æ ¸å¿ƒæ–‡ä»¶è¯¦è§£

### 1. Agent æ ¸å¿ƒï¼š`src/agent/research_agent.py`

**ä½œç”¨**ï¼šæ•´ä¸ªç³»ç»Ÿçš„"å¤§è„‘"ï¼Œè´Ÿè´£å†³ç­–å’Œåè°ƒ

**å…³é”®ç±»**ï¼š`ResearchAgent`

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class ResearchAgent:
    def __init__(self):
        # 1. åŠ è½½é…ç½®
        # 2. åˆå§‹åŒ– LLM
        # 3. åŠ è½½ç´¢å¼•ï¼ˆFAISS + BM25ï¼‰
        # 4. åˆ›å»ºå·¥å…·ï¼ˆretriever + pandas_runnerï¼‰
        # 5. ç»‘å®šå·¥å…·åˆ° LLM
    
    def run(self, query: str):
        # 1. æ¥æ”¶ç”¨æˆ·é—®é¢˜
        # 2. LLM åˆ†æé—®é¢˜ï¼Œå†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·
        # 3. æ‰§è¡Œå·¥å…·è°ƒç”¨
        # 4. æ•´åˆç»“æœ
        # 5. è¿”å›æ ¼å¼åŒ–ç­”æ¡ˆ
```

**è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼**

---

### 2. å·¥å…· 1ï¼š`src/tools/retriever_tool.py`

**ä½œç”¨**ï¼šRAG æ£€ç´¢å·¥å…·ï¼Œä»çŸ¥è¯†åº“æ‰¾ç­”æ¡ˆ

**å…³é”®ç±»**ï¼š`HybridRetriever`

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·é—®é¢˜
  â†“
å‘é‡æ£€ç´¢ï¼ˆFAISSï¼‰â†’ è¯­ä¹‰ç›¸ä¼¼åº¦
  â†“
å…³é”®è¯æ£€ç´¢ï¼ˆBM25ï¼‰â†’ ç²¾ç¡®åŒ¹é…
  â†“
èåˆåˆ†æ•° â†’ è¿”å› top-k ç»“æœ
  â†“
æ ¼å¼åŒ–è¾“å‡ºï¼ˆæ–‡ä»¶ + é¡µç ï¼‰
```

---

### 3. å·¥å…· 2ï¼š`src/tools/pandas_runner_tool.py`

**ä½œç”¨**ï¼šæ•°æ®åˆ†æå·¥å…·ï¼Œç”Ÿæˆå¹¶æ‰§è¡Œ pandas ä»£ç 

**å…³é”®ç±»**ï¼š`PandasRunner`

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·é—®é¢˜ï¼ˆ"è®¡ç®—å¹³å‡å¹´é¾„"ï¼‰
  â†“
LLM ç”Ÿæˆ pandas ä»£ç 
  â†“
æ²™ç®±æ‰§è¡Œä»£ç 
  â†“
æ ¼å¼åŒ–ç»“æœ
  â†“
è¿”å›ç»Ÿè®¡ç»“æœ + ä»£ç 
```

---

### 4. ç´¢å¼•æ„å»ºï¼š`src/ingest/indexer.py`

**ä½œç”¨**ï¼šæ„å»º FAISS å’Œ BM25 ç´¢å¼•

**å…³é”®å‡½æ•°**ï¼š
```python
def build_indexes(documents):
    # 1. åˆ›å»º FAISS å‘é‡ç´¢å¼•
    # 2. åˆ›å»º BM25 å…³é”®è¯ç´¢å¼•
    # 3. ä¿å­˜åˆ° outputs/
```

---

## ğŸ”„ å®Œæ•´è¿è¡Œæµç¨‹

### å¯åŠ¨é˜¶æ®µ

```
1. ç”¨æˆ·è¿è¡Œï¼šstreamlit run app.py
   â†“
2. app.py å¯¼å…¥ï¼šfrom src.agent import ResearchAgent
   â†“
3. ResearchAgent.__init__() æ‰§è¡Œï¼š
   â”œâ”€ åŠ è½½é…ç½®ï¼ˆconfig/settings.yamlï¼‰
   â”œâ”€ åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆconfig/.envï¼‰
   â”œâ”€ åˆå§‹åŒ– LLMï¼ˆChatOpenAIï¼‰
   â”œâ”€ åŠ è½½ç´¢å¼•ï¼ˆoutputs/faiss_index, outputs/bm25_index.pklï¼‰
   â”œâ”€ åˆ›å»ºå·¥å…·ï¼ˆretriever_tool, pandas_runner_toolï¼‰
   â””â”€ ç»‘å®šå·¥å…·åˆ° LLM
   â†“
4. Agent å°±ç»ªï¼Œç­‰å¾…ç”¨æˆ·é—®é¢˜
```

### æŸ¥è¯¢é˜¶æ®µ

```
ç”¨æˆ·è¾“å…¥ï¼š"ä»€ä¹ˆæ˜¯çƒå½¢æ€§å‡è®¾ï¼Ÿ"
   â†“
app.py è°ƒç”¨ï¼šagent.run("ä»€ä¹ˆæ˜¯çƒå½¢æ€§å‡è®¾ï¼Ÿ")
   â†“
ResearchAgent.run() æ‰§è¡Œï¼š
   â”œâ”€ æ„å»ºæ¶ˆæ¯ï¼š[system prompt, user question]
   â”œâ”€ è°ƒç”¨ LLMï¼šllm_with_tools.invoke(messages)
   â””â”€ LLM åˆ†æé—®é¢˜ï¼Œå†³å®šè°ƒç”¨ retriever å·¥å…·
   â†“
å·¥å…·æ‰§è¡Œï¼šretriever_tool.func("çƒå½¢æ€§å‡è®¾")
   â”œâ”€ HybridRetriever.search()
   â”œâ”€ FAISS å‘é‡æ£€ç´¢
   â”œâ”€ BM25 å…³é”®è¯æ£€ç´¢
   â”œâ”€ èåˆåˆ†æ•°
   â””â”€ è¿”å›ç›¸å…³æ®µè½
   â†“
ç»“æœæ•´åˆï¼š
   â”œâ”€ å·¥å…·ç»“æœè¿”å›ç»™ LLM
   â”œâ”€ LLM åŸºäºæ£€ç´¢å†…å®¹ç”Ÿæˆç­”æ¡ˆ
   â””â”€ æ ¼å¼åŒ–è¾“å‡ºï¼ˆConclusion, Evidence, Sourcesï¼‰
   â†“
è¿”å›ç»™ç”¨æˆ·
```

---

## ğŸ¬ ä¸‰ç§è¿è¡Œæ–¹å¼

### æ–¹å¼ 1ï¼šWeb ç•Œé¢

```bash
streamlit run app.py
```

**æ‰§è¡Œè·¯å¾„**ï¼š
```
app.py
  â†’ å¯¼å…¥ ResearchAgent
  â†’ åˆå§‹åŒ– Agentï¼ˆåŠ è½½ç´¢å¼•ã€åˆ›å»ºå·¥å…·ï¼‰
  â†’ Streamlit UI æ¸²æŸ“
  â†’ ç”¨æˆ·è¾“å…¥é—®é¢˜
  â†’ agent.run(query)
  â†’ æ˜¾ç¤ºç»“æœ
```

### æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œ

```bash
python main.py
```

**æ‰§è¡Œè·¯å¾„**ï¼š
```
main.py
  â†’ å¯¼å…¥ ResearchAgent
  â†’ åˆå§‹åŒ– Agent
  â†’ äº¤äº’å¼å¾ªç¯
  â†’ ç”¨æˆ·è¾“å…¥é—®é¢˜
  â†’ agent.run(query)
  â†’ æ‰“å°ç»“æœ
```

### æ–¹å¼ 3ï¼šPython API

```python
from src.agent import ResearchAgent

agent = ResearchAgent()
result = agent.run("ä½ çš„é—®é¢˜")
```

---

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

### Agent å†³ç­–é€»è¾‘

**æ–‡ä»¶**ï¼š`src/agent/research_agent.py`

**å…³é”®ä»£ç **ï¼š
```python
def run(self, query: str):
    messages = [("system", SYSTEM_PROMPT), ("human", query)]
    
    response = self.llm_with_tools.invoke(messages)
    
    # LLM è‡ªåŠ¨å†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·
    if response.tool_calls:
        # æ‰§è¡Œå·¥å…·è°ƒç”¨
        tool_results = self._execute_tool_calls(response)
        # å°†ç»“æœè¿”å›ç»™ LLM ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
```

### æ··åˆæ£€ç´¢å®ç°

**æ–‡ä»¶**ï¼š`src/tools/retriever_tool.py`

**å…³é”®ä»£ç **ï¼š
```python
class HybridRetriever:
    def search(self, query: str):
        # 1. å‘é‡æ£€ç´¢
        vector_results = self.vectorstore.similarity_search_with_score(query)
        
        # 2. BM25 æ£€ç´¢
        bm25_results = self.bm25_index.search(query)
        
        # 3. èåˆåˆ†æ•°
        # å½’ä¸€åŒ– + åŠ æƒ
        # è¿”å› top-k
```

### ä»£ç ç”Ÿæˆä¸æ‰§è¡Œ

**æ–‡ä»¶**ï¼š`src/tools/pandas_runner_tool.py`

**å…³é”®ä»£ç **ï¼š
```python
class PandasRunner:
    def run(self, task: str):
        # 1. LLM ç”Ÿæˆä»£ç 
        code = self.generate_code(task)
        
        # 2. æ²™ç®±æ‰§è¡Œ
        exec(code, safe_globals, safe_locals)
        
        # 3. è¿”å›ç»“æœ
        return formatted_result
```

---

## ğŸ“Š æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·é—®é¢˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ResearchAgent  â”‚ â† æ ¸å¿ƒå†³ç­–å±‚
â”‚   (å¤§è„‘)        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ å†³ç­–ï¼šéœ€è¦æ£€ç´¢ï¼Ÿ
       â”‚         â†“
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚ retriever    â”‚
       â”‚    â”‚ (RAGå·¥å…·)    â”‚
       â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”‚
       â”‚           â”œâ”€â†’ FAISS å‘é‡æ£€ç´¢
       â”‚           â”œâ”€â†’ BM25 å…³é”®è¯æ£€ç´¢
       â”‚           â””â”€â†’ èåˆç»“æœ
       â”‚
       â””â”€â†’ å†³ç­–ï¼šéœ€è¦åˆ†æï¼Ÿ
                 â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ pandas_runnerâ”‚
            â”‚ (åˆ†æå·¥å…·)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€â†’ LLM ç”Ÿæˆä»£ç 
                   â”œâ”€â†’ æ²™ç®±æ‰§è¡Œ
                   â””â”€â†’ è¿”å›ç»“æœ
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ¼å¼åŒ–ç­”æ¡ˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒæ–‡ä»¶æ€»ç»“

| æ–‡ä»¶ | ä½œç”¨ | é‡è¦æ€§ |
|------|------|--------|
| `src/agent/research_agent.py` | Agent ä¸»ç±»ï¼Œå†³ç­–æ ¸å¿ƒ | â­â­â­â­â­ |
| `src/tools/retriever_tool.py` | RAG æ£€ç´¢å·¥å…· | â­â­â­â­â­ |
| `src/tools/pandas_runner_tool.py` | æ•°æ®åˆ†æå·¥å…· | â­â­â­â­ |
| `src/ingest/indexer.py` | ç´¢å¼•æ„å»º | â­â­â­ |
| `src/agent/prompts.py` | System Prompt | â­â­â­â­ |
| `app.py` | Web å…¥å£ | â­â­â­ |
| `main.py` | CLI å…¥å£ | â­â­â­ |

---

## ğŸ’¡ å¿«é€Ÿç†è§£

**ä¸€å¥è¯æ€»ç»“**ï¼š
- **æ ¸å¿ƒ**ï¼š`ResearchAgent` ç±»ï¼ˆ`src/agent/research_agent.py`ï¼‰
- **å·¥å…·**ï¼š`retriever`ï¼ˆæ£€ç´¢ï¼‰å’Œ `pandas_runner`ï¼ˆåˆ†æï¼‰
- **è¿è¡Œ**ï¼šAgent æ¥æ”¶é—®é¢˜ â†’ é€‰æ‹©å·¥å…· â†’ æ‰§è¡Œ â†’ è¿”å›ç»“æœ

**ä¿®æ”¹ç³»ç»Ÿè¡Œä¸º**ï¼š
- æ”¹å†³ç­–é€»è¾‘ â†’ ä¿®æ”¹ `research_agent.py`
- æ”¹æ£€ç´¢ç­–ç•¥ â†’ ä¿®æ”¹ `retriever_tool.py`
- æ”¹è¾“å‡ºæ ¼å¼ â†’ ä¿®æ”¹ `prompts.py`

